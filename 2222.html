<!DOCTYPE html>
<html lang="zh">

<head>
  <meta charset="UTF-8">
  <title>XML Folder Viewer</title>
</head>

<body>
  <h1>ä¸Šä¼ XMLæ–‡ä»¶å¤¹</h1>
  <input type="file" id="folderInput" webkitdirectory directory multiple />
  <div id="output"></div>

  <script>
    const folderInput = document.getElementById("folderInput");
    const output = document.getElementById("output");
    folderInput.addEventListener("change", async (e) => {
      const files = Array.from(e.target.files);
      const fileMap = {};

      files.forEach(f => fileMap[f.webkitRelativePath] = f);

      console.log("å…¨éƒ¨æ–‡ä»¶è·¯å¾„:");
      files.forEach(f => console.log(f.webkitRelativePath));

      const folderRoots = new Set();

      files.forEach(file => {
        const parts = file.webkitRelativePath.split("/");
        if (parts.length >= 3) {
          folderRoots.add(`${parts[0]}/${parts[1]}`);
        }
      });

      console.log("æœ‰æ•ˆå­ç›®å½•ï¼š", folderRoots);

      for (const folder of folderRoots) {
        const xmlPath = `${folder}/result.xml`;
        const xmlFile = fileMap[xmlPath];
        if (!xmlFile) {
          console.warn("æœªæ‰¾åˆ°xmlæ–‡ä»¶:", xmlPath);
          continue;
        }

        const xmlText = await xmlFile.text();
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(xmlText, "application/xml");

        const title = xmlDoc.querySelector("title")?.textContent || "æ— æ ‡é¢˜";
        const section = document.createElement("section");
        section.innerHTML = `<h2>ğŸ“„ ${folder}: ${title}</h2>`;

        xmlDoc.querySelectorAll("body > p").forEach(p => {
          const para = document.createElement("p");
          para.textContent = p.textContent;
          section.appendChild(para);
        });

        xmlDoc.querySelectorAll("figure").forEach(fig => {
          const figTitle = fig.querySelector("title")?.textContent || "";
          const imgSrc = fig.querySelector("image")?.getAttribute("href") || "";
          const altText = fig.querySelector("alt")?.textContent || "";
          const fullImgPath = `${folder}/${imgSrc}`;
          const imgFile = fileMap[fullImgPath];

          if (imgFile) {
            const imgURL = URL.createObjectURL(imgFile);
            const img = document.createElement("img");
            img.src = imgURL;
            img.alt = altText;
            img.style.maxWidth = "100%";

            const caption = document.createElement("figcaption");
            caption.textContent = figTitle;

            const figure = document.createElement("figure");
            figure.appendChild(img);
            figure.appendChild(caption);
            section.appendChild(figure);
          } else {
            console.warn("æœªæ‰¾åˆ°å›¾ç‰‡æ–‡ä»¶:", fullImgPath);
          }
        });

        output.appendChild(section);
      }
    });

  </script>
</body>

</html>